/* See LICENSE file for copyright and license details. */
#include <err.h>
#include <fcntl.h>
#include <sys/soundcard.h>
#include <sys/ioctl.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <unistd.h>
#include <wchar.h>
#include <locale.h>
#include "../util.h"

//0x2800 ⠀0: 1

//1: 8   8/256*100 = 3.125
wint_t low[8] = { 0x2802, 0x2801, 0x2808, 0x2810, 0x2820, 0x2880, 0x2840, 0x2804 };
// 2: 27   27/256*100 = 10.54
wint_t lowmid[27] = {  0x2803, 0x2841, 0x2842, 0x2805, 0x2806, 0x2809, 0x2821, 0x2822, 0x2844, 0x2848, 0x2828, 0x2824, 0x280a, 0x280c, 0x2811, 0x2812, 0x2881, 0x2882, 0x2884, 0x2888, 0x2890, 0x28a0, 0x28c0, 0x2814, 0x2818, 0x2830, 0x2860 };
//3: 57 57/256*100 = 22.2
wint_t midlow[57] = { 0x2861, 0x2862, 0x2864, 0x2868, 0x2870, 0x288c, 0x2891, 0x2892, 0x2894, 0x2898, 0x2807, 0x2831, 0x2832, 0x2843, 0x284a, 0x284c, 0x2850, 0x2845, 0x2846, 0x2851, 0x2849, 0x2834, 0x2838, 0x2823, 0x2825, 0x2826, 0x280b, 0x280d, 0x280e, 0x2813, 0x2815, 0x2816, 0x2819, 0x281a, 0x281c, 0x2829, 0x282a, 0x282c, 0x2852, 0x2854, 0x2858, 0x28a1, 0x28a4, 0x28a2, 0x28a8, 0x28b0, 0x28c1, 0x28c2, 0x28c4, 0x28c8, 0x28d0, 0x28e0, 0x2883, 0x2885, 0x2886, 0x2889, 0x288a };
// 4: 70  70/256*100 = 27 -> 28
wint_t mid[70] = { 0x28c9, 0x288b, 0x2887, 0x284b, 0x284d, 0x280f, 0x2847, 0x284e, 0x28b1, 0x28b2, 0x28b4, 0x282b, 0x282d, 0x28b8, 0x28ca, 0x28c3, 0x28c5, 0x28c6, 0x28cc, 0x28d1, 0x28a9, 0x289c, 0x28a3, 0x28a5, 0x28a6, 0x28aa, 0x28ac, 0x28d2, 0x28d4, 0x28d8, 0x28e4, 0x2817, 0x282e, 0x2833, 0x2835, 0x2836, 0x2839, 0x283c, 0x281b, 0x281d, 0x281e, 0x2827, 0x28f0, 0x28e8, 0x28e1, 0x28e2, 0x2853, 0x2855, 0x2856, 0x2859, 0x285a, 0x285c, 0x2871, 0x2863, 0x2865, 0x2866, 0x2869, 0x286c, 0x286a, 0x2872, 0x2874, 0x2878, 0x288e, 0x288d, 0x2893, 0x2895, 0x2896, 0x2899, 0x289a };
// 5: 57  57/256*100 = 22.2
wint_t midhigh[57] = { 0x2857, 0x2897, 0x288f, 0x289b, 0x289d, 0x285b, 0x285d, 0x285e, 0x2875, 0x2867, 0x286b, 0x286d, 0x284f, 0x286e, 0x2876, 0x2879, 0x282f, 0x281f, 0x283b, 0x283e, 0x283d, 0x28e3, 0x28ec, 0x28d3, 0x28ce, 0x28b3, 0x28b5, 0x28b6, 0x28b9, 0x28ba, 0x28ae, 0x28bc, 0x28d5, 0x28d9, 0x28d6, 0x28da, 0x28cb, 0x28c7, 0x28cd, 0x28dc, 0x28f1, 0x28f2, 0x28e5, 0x28e9, 0x28e6, 0x28ea, 0x28f4, 0x28f5, 0x28f8, 0x28ab, 0x28a7, 0x289e, 0x28ad, 0x287c };
//6: 27 27*256*100 = 10.54
wint_t highmid[27] = { 0x28af, 0x287d, 0x287e, 0x287b, 0x283f, 0x285f, 0x286f, 0x2877, 0x289f, 0x28be, 0x28bd, 0x28e7, 0x28db, 0x28cf, 0x28dd, 0x28de, 0x28ed, 0x28d7, 0x28ee, 0x28b7, 0x28bb, 0x28f3, 0x28fa, 0x28eb, 0x28fc, 0x28f9, 0x28f6 };

//7: 8 8/256*100 = 3.125
wint_t high[8] = { 0x28fe, 0x287f, 0x28bf, 0x28df, 0x28ef, 0x28fb, 0x28f7, 0x28fd};
  
// 0x28ff ⣿ 8: 1



const char *
myvol_perc(const char *card)
{
	unsigned int i;
	int v, afd, devmask;
	char *vnames[] = SOUND_DEVICE_NAMES;

	afd = open(card, O_RDONLY | O_NONBLOCK);
	if (afd == -1) {
		warn("Cannot open %s", card);
		return NULL;
	}

	if (ioctl(afd, SOUND_MIXER_READ_DEVMASK, &devmask) == -1) {
		warn("Cannot get volume for %s", card);
		close(afd);
		return NULL;
	}
	for (i = 0; i < LEN(vnames); i++) {
		if (devmask & (1 << i) && !strcmp("vol", vnames[i])) {
			if (ioctl(afd, MIXER_READ(i), &v) == -1) {
				warn("vol_perc: ioctl");
				close(afd);
				return NULL;
			}
		}
	}

	close(afd);
	setlocale(LC_ALL, "");

	
	char *buf = malloc(sizeof(char)*30);
	if (v==0) {
	  sprintf(buf,"%lc", 0x2800);
	} else if (v > 0 && v <= (10*257)) {
	   sprintf(buf,"%lc", low[(arc4random() % ((unsigned)8))]);
	} else if (v > (10*257) && v <= (20*257)) {
	   sprintf(buf,"%lc", lowmid[(arc4random() % ((unsigned)27))]);
	} else if (v > (20*257) && v <= (30*257)) {
	   sprintf(buf,"%lc", midlow[(arc4random() % ((unsigned)57))]);
	} else if (v > (30*257) && v <= (40*257)) {
	   sprintf(buf,"%lc", mid[(arc4random() % ((unsigned)70))]);
	} else if (v > (40*257) && v <= (50*257)) {
	   sprintf(buf,"%lc", mid[(arc4random() % ((unsigned)70))]);
	} else if (v > (50*257) && v <= (60*257)) {
	   sprintf(buf,"%lc", mid[(arc4random() % ((unsigned)70))]);
	} else if (v > (60*257) && v <= (70*257)) {
	   sprintf(buf,"%lc", midhigh[(arc4random() % ((unsigned)57))]);
	} else if (v > (70*257) && v <= (80*257)) {
	   sprintf(buf,"%lc", highmid[(arc4random() % ((unsigned)27))]);
	} else if (v > (80*257) && v <= (99*257)) {
	   sprintf(buf,"%lc", high[(arc4random() % ((unsigned)8))]);
	} else if ( v == (100*257)) {
	   sprintf(buf,"%lc", 0x28ff);
	} 
	return (char*) buf;
}
